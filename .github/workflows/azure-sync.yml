name: Sync Azure DevOps Repo to GitHub

# Allow the job to push using GITHUB_TOKEN
permissions:
  contents: write

on:
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (for workspace)
        uses: actions/checkout@v3

      - name: Ensure git installed
        run: sudo apt-get update && sudo apt-get install -y git

      - name: Clone Azure DevOps repo (using AZURE_DEVOPS_PAT)
        run: |
          echo "Cloning Azure DevOps repo..."
          # Use PAT in URL to authenticate clone
          git clone --mirror "https://fabric0316:${{ secrets.AZURE_DEVOPS_PAT }}@dev.azure.com/fabric0316/OilandGas/_git/OilGas-DataEngineering" azure-devops.git

      - name: Push to GitHub (authenticated with GITHUB_TOKEN)
        env:
          GITHUB_REPO: sandhya-datatech/OilGas-DataEngineering
          GITHUB_PUSH_URL: https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/sandhya-datatech/OilGas-DataEngineering.git
        run: |
          cd azure-devops.git
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"
          git remote add github "${GITHUB_PUSH_URL}"
          # Mirror push to preserve all refs (branches/tags). CAUTION: will overwrite remote refs.
          git push github --mirror
          echo "Done!"
